<!doctype html>
<html lang="en">
<head>
    <link href="style.css" rel="stylesheet" type="text/css">
    <script src="https://kit.fontawesome.com/1ad39c7d2a.js"></script>
    <title></title>
</head>
<body>
<div id="buttons">
	<!--<button id="playpausebtn"></button>
    <button id="mutebtn"></button>-->
</div>
<div id="background">
</div>
<div id="logo">
    <div id="log" class="log">Błąd podczas inicjalizacji dziennika ładowania.</div>
    <div id="debug" class="log log-top-right"></div>
    <div class="loading-container">
        <div class="mute">
            <i onclick="mute()" id="muteicon" class="fas fa-volume-up mute-button"></i>
        </div>
        <div class ="loading-labels">
            <div id="INIT_BEFORE_MAP_LOADED-label" class="color-first">Preinicjalizacja</div>
            <div id="MAP-label" class="color-second">Mapa</div>
            <div id="INIT_AFTER_MAP_LOADED-label" class="color-third">Postinicjalizacja</div>
            <div id="INIT_SESSION-label" class="color-fourth">Sesja</div>
        </div>
        <div class="loading-bar-container">
            <div id="INIT_BEFORE_MAP_LOADED-bar" class="loading-bar bgcolor-first"></div>
            <div id="MAP-bar" class="loading-bar bgcolor-second"></div>
            <div id="INIT_AFTER_MAP_LOADED-bar" class="loading-bar bgcolor-third"></div>
            <div id="INIT_SESSION-bar" class="loading-bar bgcolor-fourth"></div>
        </div>
    </div>
</div>

<script type="text/javascript">

	var audio, mutebtn, seek_bar;
	var songs = ["https://cdn.strefarp.pl/loading_music.mp3", "https://cdn.strefarp.pl/loading_music_2.mp3", "https://cdn.strefarp.pl/loading_music_3.mp3", "https://cdn.strefarp.pl/loading_music_4.mp3"]
	
	function initAudioPlayer(){
		audio = new Audio();
		audio.src = songs[Math.floor(Math.random()*songs.length)];
		audio.loop = true;
		const playPromise = audio.play();
		if (playPromise !== null){
			playPromise.catch(() => { audio.play(); })
		}
		
        //mutebtn = document.getElementById("mutedicon");
		//mutebtn.addEventListener("click", mute);
		
	}
	
	function mute(){
			if(document.getElementById("muteicon").classList.contains('fa-volume-up')){
				document.getElementById("muteicon").classList.remove('fa-volume-up');
				document.getElementById("muteicon").classList.add('fa-volume-mute');
				audio.muted = true;
			} else {
				audio.muted = false;
				document.getElementById("muteicon").classList.remove('fa-volume-mute');
				document.getElementById("muteicon").classList.add('fa-volume-up');
			}
		}
	
	window.addEventListener("load", initAudioPlayer);
    
    if (!String.format) {
        String.format = function(format) {
            let args = Array.prototype.slice.call(arguments, 1);
            return format.replace(/{(\d+)}/g, function(match, number) {
                return typeof args[number] != 'undefined'
                    ? args[number]
                    : match
                    ;
            });
        };
    }
    const technicalNames = ["INIT_BEFORE_MAP_LOADED", "MAP", "INIT_AFTER_MAP_LOADED", "INIT_SESSION"];
    let currentLoadingStage = 0;
    let loadingWeights = [1.5/10, 4/10, 1.5/10, 3/10];
    let loadingTotals = [70, 70, 70, 220];
    let registeredTotals = [0, 0, 0, 0];
    let stageVisible = [false, false, false, false];
    let currentProgress = [0.0, 0.0, 0.0, 0.0];
    let currentLoadingCount = 0;
    let minScale = 1.03;
    let maxScale = 2.00;
    let diffScale = maxScale - minScale;
    let backgroundPositionEnd = [200, 150];
    function doProgress(stage)
    {
        let idx = technicalNames.indexOf(stage);
        if(idx >= 0)
        {
            registeredTotals[idx]++;
            if(idx > currentLoadingStage)
            {
                while(currentLoadingStage < idx)
                {
                    currentProgress[currentLoadingStage] = 1.0;
                    currentLoadingStage++;
                }
                currentLoadingCount = 1;
            }
            else
                currentLoadingCount++;
            currentProgress[currentLoadingStage] = Math.min(currentLoadingCount/loadingTotals[idx], 1.0);
            updateProgress();
        }
    }
    const totalWidth = 99.1;
    let progressPositions = [];
    let progressMaxLengths = [];
    progressPositions[0] = 0.0;
    let i = 0;
    while(i < currentProgress.length)
    {
        progressMaxLengths[i] = loadingWeights[i] * totalWidth;
        progressPositions[i+1] = progressPositions[i] + progressMaxLengths[i];
        i++;
    }
    function updateBackground()
    {
        let i = 0;
        currentProgressWeightedSum = 0;
        while(i < currentProgress.length)
        {
            currentProgressWeightedSum += currentProgress[i]*loadingWeights[i];
            i++;
        }
        document.querySelector('#background').style.transform = String.format('scale({0})', minScale + diffScale * currentProgressWeightedSum);
        document.querySelector('#background').style.backgroundPosition = String.format('{0}px {1}px', backgroundPositionEnd[0] * currentProgressWeightedSum, backgroundPositionEnd[1] * currentProgressWeightedSum);
    }
    function updateProgress()
    {
        document.querySelector('#debug').innerHTML = '';
        let i = 0;
        while(i <= currentLoadingStage)
        {
            if((currentProgress[i] > 0 || !currentProgress[i-1]) && !stageVisible[i])
            {
                document.querySelector("#" + technicalNames[i]+"-label").style.display = 'inline-block';
                document.querySelector("#" + technicalNames[i]+"-bar").style.display = 'inline-block';
                stageVisible[i] = true;
            }
            document.querySelector("#" + technicalNames[i]+"-bar").style.width = currentProgress[i]*progressMaxLengths[i] + '%';
            document.querySelector("#" + technicalNames[i]+"-label").style.width = progressMaxLengths[i] + '%';
            document.querySelector('#debug').innerHTML += String.format('{0}: {1}<br>', technicalNames[i], currentProgress[i]);
            i++;
        }
        updateBackground();
    }
    updateProgress();
    let count = 0;
    const gstate = {
        elems: [],
        log: []
    };
    function printLog(type, str){
        gstate.log.push({ type: type, str: str });
    };
    Array.prototype.last = function()
    {
        return this[this.length - 1];
    };
    const handlers = {
        startInitFunction(data)
        {
            gstate.elems.push({
                name: data.type,
                orders: []
            });
            printLog(1, String.format('Uruchamiam funkcje inicjalizacyjne na etapie {0}...', data.type));
            if(data.type) doProgress(data.type);
        },
        startInitFunctionOrder(data)
        {
            count = data.count;
            printLog(1, String.format('Wywołuję funkcje o priorytecie {1} (całkowicie {2})...', data.type, data.order, data.count));
            if(data.type) doProgress(data.type);
        },
        initFunctionInvoking(data)
        {
            printLog(3, String.format('Wywołuję funkcję {0} z etapu {1}, {2} z {3}.', data.name, data.type, data.idx, count));
            if(data.type) doProgress(data.type);
        },
        initFunctionInvoked(data)
        {
            if(data.type) doProgress(data.type);
        },
        endInitFunction(data)
        {
            printLog(1, String.format('Ukończyłem etap inicjalizacyjny {0}.', data.type));
            if(data.type) doProgress(data.type);
        },
        startDataFileEntries(data)
        {
            count = data.count;
            printLog(1, 'Wczytuję mapę...');
            if(data.type) doProgress(data.type);
        },
        onDataFileEntry(data)
        {
            printLog(3, String.format('Wczytuję plik {0}...', data.name));
            doProgress(data.type);
            if(data.type) doProgress(data.type);
        },
        endDataFileEntries()
        {
            printLog(1, 'Wczytałem mapę.');
        },
        performMapLoadFunction(data)
        {
            doProgress('MAP');
        },
        onLogLine(data)
        {
            switch (data.message) {
                case 'Initializing session':
                    printLog(3, 'Rozpoczynam sesję...');
                    break;
                default:
                    printLog(3, data.message);
            }
        }
    };
    setInterval(function(){document.querySelector('#log').innerHTML = gstate.log.slice(-10).map(function(e){return String.format("{1}", e.type, e.str)}).join('<br>');}, 100);
    window.addEventListener('message', function(e)
    {
        (handlers[e.data.eventName] || function() {})(e.data);
    });
    if (!window.invokeNative)
    {
        var newType = function newType(name) {
            return function () {
                return handlers.startInitFunction({ type: name });
            };
        };
        var newOrder = function newOrder(name, idx, count) {
            return function () {
                return handlers.startInitFunctionOrder({ type: name, order: idx, count: count });
            };
        };
        var newInvoke = function newInvoke(name, func, i) {
            return function () {
                handlers.initFunctionInvoking({ type: name, name: func, idx: i });handlers.initFunctionInvoked({ type: name });
            };
        };
        var startEntries = function startEntries(count) {
            return function () {
                return handlers.startDataFileEntries({ count: count });
            };
        };
        var addEntry = function addEntry() {
            return function () {
                return handlers.onDataFileEntry({ name: 'meow', isNew: true });
            };
        };
        var stopEntries = function stopEntries() {
            return function () {
                return handlers.endDataFileEntries({});
            };
        };
        var newTypeWithOrder = function newTypeWithOrder(name, count) {
            return function () {
                newType(name)();newOrder(name, 1, count)();
            };
        };
        const demoFuncs = [
            newTypeWithOrder('MAP', 5),
            newInvoke('MAP', 'meow1', 1),
            newInvoke('MAP', 'meow2', 2),
            newInvoke('MAP', 'meow3', 3),
            newInvoke('MAP', 'meow4', 4),
            newInvoke('MAP', 'meow5', 5),
            newOrder('MAP', 2, 2),
            newInvoke('MAP', 'meow1', 1),
            newInvoke('MAP', 'meow2', 2),
            startEntries(6),
            addEntry(),
            addEntry(),
            addEntry(),
            addEntry(),
            addEntry(),
            addEntry(),
            stopEntries(),
            newTypeWithOrder('INIT_SESSION', 4),
            newInvoke('INIT_SESSION', 'meow1', 1),
            newInvoke('INIT_SESSION', 'meow2', 2),
            newInvoke('INIT_SESSION', 'meow3', 3),
            newInvoke('INIT_SESSION', 'meow4', 4),
        ];
        setInterval(function(){	demoFuncs.length && demoFuncs.shift()();}, 350);
    }
	
	window.onload = function() {
		document.body.addEventListener("mousemove", function(event){
		var x = event.pageX - 6 + "px";
		var y = event.pageY + "px";
		document.getElementById("cursor").style.left = x;
		document.getElementById("cursor").style.top = y;
	  })
	};
	
	window.addEventListener("load", initAudioPlayer);
</script>

	<i id="cursor" class="fas fa-mouse-pointer"></i>
	<style>
		#cursor {
		width: 35px;
		height: 35px;
		position: fixed;
		z-index: 3;
		}
	</style>
	<script src="cursor.js"></script>

</body>
</html>